<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>四中贴吧 - 发现精彩内容</title>
    <link rel="stylesheet" href="css/main.css" />
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="css/fa.all.min.css" />
  </head>
  <body>
    <!-- 加载动画 -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">四中贴吧加载中...</p>
      </div>
    </div>

    <div id="app" class="app-container" v-show="vueAppStatus.mounted">
      <!-- 顶部导航栏 -->
      <header class="navbar">
        <div class="nav-container">
          <div class="nav-brand">
            <div class="logo">
              <i class="fas fa-comments"></i>
            </div>
            <h1 class="site-title">四中贴吧</h1>
          </div>

          <div class="nav-search">
            <div class="search-box">
              <input
                type="text"
                id="search"
                v-model="searchQuery"
                placeholder="搜索帖子、用户或话题..."
              />
              <button class="search-btn" @click="search" title="搜索">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>

          <div class="nav-actions">
            <div class="action-buttons">

              <button class="btn-create-bar" @click="createBar">
                <i class="fas fa-plus-circle"></i>
                <span>创建贴吧</span>
              </button>
            </div>

            <div class="user-menu">
              <button v-if="!isLoggedIn" class="btn-login" @click="showModal('login')">登录</button>
              <button v-if="!isLoggedIn" class="btn-register" @click="showModal('register')">注册</button>
              <button v-else class="btn-logout" @click="logout">
                <i class="fas fa-sign-out-alt"></i>
                <span>登出</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- 主要内容区 -->
      <main class="main-content">
        <div class="content-container">
          <!-- 左侧边栏 -->
          <aside class="sidebar sidebar-left">
            <div class="sidebar-section">
              <h3 class="section-title">
                <i class="fas fa-fire"></i>
                热门贴吧
              </h3>
              <ul class="bars-list">
                <li v-for="bar in state.hotBars" :key="bar.id" class="bar-item" @click="loadPostsInBar(bar.id)">
                  <div class="bar-name">{{ displayBarName(bar.name) }}</div>
                  <div class="bar-count">{{ bar.post_count || 0 }}</div>
                  <button v-if="isLoggedIn && !isBarFollowed(bar.id)" class="btn-follow" @click.stop="followBar(bar.id)">关注</button>
                  <button v-else-if="isLoggedIn && isBarFollowed(bar.id)" class="btn-unfollow" @click.stop="unfollowBar(bar.id)">取消关注</button>
                  <button v-else class="btn-follow" @click.stop="showModal('login')">关注</button>
                </li>
              </ul>
            </div>

            <div class="sidebar-section">
              <h3 class="section-title">
                <i class="fas fa-star"></i>
                我的关注
              </h3>
              <ul class="bars-list">
                <li v-for="bar in state.userBars" :key="bar.id" class="bar-item small" @click="loadPostsInBar(bar.id)">
                  <div class="bar-name">{{ displayBarName(bar.name) }}</div>
                  <div class="bar-actions">
                    <button class="btn-post" @click.stop="openPostInBar(bar.id)" title="在此贴吧发帖">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-unfollow" @click.stop="unfollowBar(bar.id)">取消关注</button>
                  </div>
                </li>
              </ul>
            </div>
          </aside>

          <!-- 中间内容区 -->
          <section class="content-area">
            <div class="content-header">
              <div class="content-title">
                <h2 class="page-title">{{ state.currentBar ? displayBarName(state.currentBar.name) : '最新帖子' }}</h2>
                <div class="content-actions">
                  <button v-if="state.currentBar" class="btn-post-in-bar" @click="openPostInBar(state.currentBar.id)" title="在此贴吧发帖">
                    <i class="fas fa-edit"></i>
                    <span>发帖</span>
                  </button>
                  <button v-if="state.currentBar" class="btn-back-to-posts" @click="backToLatestPosts" title="回到最新帖子">
                    <i class="fas fa-arrow-left"></i>
                    <span>最新帖子</span>
                  </button>
                </div>
              </div>
              <div v-if="!state.currentBar" class="filter-options">
                <button class="filter-btn active" @click="loadLatestPosts">全部</button>
                <button class="filter-btn" @click="loadHotPosts">热门</button>
                <button class="refresh-btn" @click="refreshPosts" title="刷新帖子">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>

            <div class="posts-container">
              <div v-if="state.posts.length === 0" class="empty-state"><i class="fas fa-inbox"></i><p>暂无帖子</p></div>
              <div v-for="(post, index) in state.posts" :key="post.id" class="post" :data-index="index">
                <div class="post-header">
                  <div class="post-avatar">{{ post.author_name ? post.author_name.charAt(0).toUpperCase() : "U" }}</div>
                  <div class="post-meta">
                    <div class="post-author">{{ escapeHtml(post.author_name || "匿名用户") }}</div>
                    <div class="post-time">{{ formatTime(post.create_time) }}</div>
                  </div>
                </div>
                <h3 class="post-title">{{ escapeHtml(post.title) }}</h3>
                <div class="post-content">{{ escapeHtml(post.content ? post.content.slice(0, 200) + (post.content.length > 200 ? "..." : "") : "") }}</div>
                <div class="post-footer">
                  <div class="post-stats">
                    <span class="stat"><i class="fas fa-comment"></i> {{ post.comment_count || 0 }}</span>
                    <span class="stat"><i class="fas fa-heart"></i> {{ post.like_count || 0 }}</span>
                  </div>
                  <div class="post-actions">
                    <button class="btn btn-primary" @click="openPost(post.id)">
                      <i class="fas fa-arrow-right"></i> 查看详情
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="load-more">
              <button class="load-more-btn">加载更多</button>
            </div>
          </section>

          <!-- 右侧边栏 -->
          <aside class="sidebar sidebar-right">
            <div class="sidebar-card">
              <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                使用提示
              </h3>
              <p>欢迎来到四中贴吧！在这里您可以：</p>
              <br>
              <ul class="tips-list">
                <li>浏览热门话题和帖子</li>
                <li>关注感兴趣的贴吧</li>
                <li>登录后发布新帖</li>
                <li>评论和点赞他人内容</li>
              </ul>
            </div>

            <div class="sidebar-card">
              <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                社区统计
              </h3>
              <div class="stats">
                <div class="stat-item">
                  <span class="stat-value">{{ formatNumber(state.stats.posts || 0) }}</span>
                  <span class="stat-label">帖子总数</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ formatNumber(state.stats.users || 0) }}</span>
                  <span class="stat-label">用户总数</span>
                </div>
                <div class="stat-item">
                  <span class="stat-value">{{ formatNumber(state.stats.comments || 0) }}</span>
                  <span class="stat-label">评论总数</span>
                </div>
              </div>
            </div>
          </aside>
        </div>
      </main>

      <!-- 登录模态框 -->
      <div v-if="state.modals.login" class="modal show">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">登录账号</h3>
            <button class="modal-close" @click="hideAllModals()" title="关闭">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="login-username">用户名</label>
              <input
                type="text"
                id="login-username"
                v-model="loginForm.username"
                placeholder="请输入用户名"
              />
            </div>
            <div class="form-group">
              <label for="login-password">密码</label>
              <input
                type="password"
                id="login-password"
                v-model="loginForm.password"
                placeholder="请输入密码"
                @keyup.enter="submitLogin"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button @click="submitLogin" class="btn btn-primary">登录</button>
            <button @click="hideAllModals" class="btn btn-secondary">
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 注册模态框 -->
      <div v-if="state.modals.register" class="modal show">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">注册账号</h3>
            <button class="modal-close" @click="hideAllModals()" title="关闭">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="register-username">用户名</label>
              <input
                type="text"
                id="register-username"
                v-model="registerForm.username"
                placeholder="请输入用户名"
                @keyup.enter="submitRegister"
              />
            </div>
            <div class="form-group">
              <label for="register-password">密码</label>
              <input
                type="password"
                id="register-password"
                v-model="registerForm.password"
                placeholder="请输入密码"
                @keyup.enter="submitRegister"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button @click="submitRegister" class="btn btn-primary">注册</button>
            <button @click="hideAllModals" class="btn btn-secondary">
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 发帖模态框 -->
      <div v-if="state.modals.post" class="modal show">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 class="modal-title">发布新帖</h3>
            <button class="modal-close" @click="hideAllModals()" title="关闭">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="post-title">标题</label>
              <input type="text" id="post-title" v-model="postForm.title" placeholder="请输入帖子标题" />
            </div>
            <div class="form-group">
              <label for="post-content">内容</label>
              <textarea
                id="post-content"
                v-model="postForm.content"
                placeholder="分享您的想法..."
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button @click="submitPost" class="btn btn-primary">发布</button>
            <button @click="hideAllModals" class="btn btn-secondary">
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 创建贴吧模态框 -->
      <div v-if="state.modals.createBar" class="modal show">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">创建贴吧</h3>
            <button class="modal-close" @click="hideAllModals()" title="关闭">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="bar-name">贴吧名称</label>
              <div class="input-with-suffix">
                <input type="text" id="bar-name" v-model="createBarForm.name" placeholder="请输入贴吧名称" />
                <span class="input-suffix">吧</span>
              </div>
              <div class="form-hint">无需在名称末尾输入"吧"字</div>
            </div>
            <div class="form-group">
              <label for="bar-description">贴吧简介</label>
              <textarea
                id="bar-description"
                v-model="createBarForm.description"
                placeholder="请输入贴吧简介（可选）"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button @click="submitCreateBar" class="btn btn-primary">创建</button>
            <button @click="hideAllModals" class="btn btn-secondary">
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 帖子详情模态框 -->
      <div v-if="state.modals.postDetail" class="modal show">
        <div class="modal-content modal-large">
          <div class="modal-header">
            <h3 class="modal-title">{{ state.currentPost ? escapeHtml(state.currentPost.title) : "帖子详情" }}</h3>
            <button class="modal-close" @click="hideAllModals()" title="关闭">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body" v-if="state.currentPost">
            <div class="post-detail-header">
              <div class="post-detail-meta">
                <span>作者: {{ state.currentPost.author_name || state.currentPost.author_id }}</span>
                <span>{{ formatTime(state.currentPost.create_time) }}</span>
              </div>
            </div>
            <div class="post-detail-content">{{ state.currentPost.content }}</div>

            <div class="comments-section">
              <h4>评论</h4>
              <div class="comments-list">
                <div v-if="state.comments.length === 0" class="empty-state">暂无评论</div>
                <div v-for="comment in state.comments" :key="comment.id" class="comment">
                  <div class="comment-content">{{ escapeHtml(comment.content) }}</div>
                  <div class="comment-meta">
                    <div class="comment-author">
                      {{ comment.author_name }}<span class="comment-time">{{ formatTime(comment.create_time) }}</span>
                    </div>
                    <div class="comment-actions">
                      <span class="comment-likes">{{ comment.likes || 0 }}</span>
                      <button 
                        class="comment-like-btn" 
                        :class="{ 'liked': comment.liked_by_user }"
                        @click="likeComment(comment.id)"
                      >
                        <i :class="comment.liked_by_user ? 'fas fa-thumbs-up' : 'far fa-thumbs-up'"></i> 
                        {{ comment.liked_by_user ? '已点赞' : '点赞' }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="comment-form" v-if="isLoggedIn">
                <div class="form-group">
                  <textarea
                    id="comment-content"
                    v-model="commentForm.content"
                    placeholder="写下您的评论..."
                    @keyup.ctrl.enter="submitComment"
                  ></textarea>
                </div>
                <button @click="submitComment" class="btn btn-primary">
                  发表评论
                </button>
              </div>
              <div v-else class="login-prompt">
                <p>请<a href="#" @click.prevent="showModal('login')">登录</a>后发表评论</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 通知提示 -->
      <div id="notification" class="notification"></div>

      <!-- 页脚 -->
      <footer class="footer">
        <div class="footer-container">
          <div class="footer-section">
            <h4>四中贴吧</h4>
            <p>一个分享、交流、学习的平台</p>
          </div>
          <div class="footer-section">
            <h4>快速链接</h4>
            <ul>
              <li><a href="#">使用指南</a></li>
              <li><a href="#">社区规范</a></li>
              <li><a href="#">意见反馈</a></li>
            </ul>
          </div>
          <div class="footer-section">
            <h4>联系我们</h4>
            <p>
              <i class="fas fa-envelope"></i>
              <a href="mailto:tieba@252123.xyz">tieba@252123.xyz</a>
            </p>
            <p>
              <i class="fa-brands fa-github"></i>
              <a href="https://github.com/gpchn/tieba">GitHub Repo</a>
            </p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 四中贴吧. 保留所有权利.</p>
        </div>
      </footer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="js/vue-app.js"></script>
  </body>
</html>
